<!doctype html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>ç¥ç¥‡æ•°æ®è°ƒè¯•å·¥å…·</title>
    <style>
      body {
        font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        padding: 20px;
        background: #f5f5f5;
      }
      .container {
        max-width: 1200px;
        margin: 0 auto;
        background: white;
        padding: 30px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
      }
      h1 {
        color: #333;
        border-bottom: 3px solid #4caf50;
        padding-bottom: 10px;
      }
      .section {
        margin: 20px 0;
        padding: 15px;
        background: #fafafa;
        border-left: 4px solid #2196f3;
      }
      .section h2 {
        margin-top: 0;
        color: #2196f3;
      }
      pre {
        background: #2d2d2d;
        color: #f8f8f8;
        padding: 15px;
        border-radius: 4px;
        overflow-x: auto;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
      .success {
        color: #4caf50;
        font-weight: bold;
      }
      .error {
        color: #f44336;
        font-weight: bold;
      }
      .warning {
        color: #ff9800;
        font-weight: bold;
      }
      button {
        background: #4caf50;
        color: white;
        border: none;
        padding: 10px 20px;
        border-radius: 4px;
        cursor: pointer;
        margin-right: 10px;
      }
      button:hover {
        background: #45a049;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸŒŸ ç¥ç¥‡æ•°æ®è°ƒè¯•å·¥å…·</h1>

      <div class="section">
        <h2>æ“ä½œ</h2>
        <button onclick="checkGameState()">æ£€æŸ¥æ¸¸æˆçŠ¶æ€</button>
        <button onclick="checkCharacterData()">æ£€æŸ¥è§’è‰²å¡æ•°æ®</button>
        <button onclick="testDeityParsing()">æµ‹è¯•ç¥ç¥‡è§£æ</button>
        <button onclick="manuallySetDeity()">æ‰‹åŠ¨è®¾ç½®ç¥ç¥‡</button>
      </div>

      <div id="results"></div>
    </div>

    <script>
      // æµ‹è¯•ç¥ç¥‡è§£æå‡½æ•°ï¼ˆä»ä»£ç ä¸­å¤åˆ¶ï¼‰
      function parseDeityFromCharacterBackground(background) {
        if (!background) return null;

        // æ£€æµ‹æ˜¯å¦æåˆ°æˆç¥
        const deityPatterns = [/(?:æˆä¸º|æ™‹å‡ä¸º|è·å¾—äº†?|å·²ç»æ˜¯|ç°åœ¨æ˜¯)([åŠ]?ç¥|å®ˆæŠ¤[åŠ]?ç¥|ç¥[ç¥‡ç¥—])/, /ç¥æ ¼|ç¥åŠ›|ç¥æ€§/];

        let isDivine = false;
        for (const pattern of deityPatterns) {
          if (pattern.test(background)) {
            isDivine = true;
            break;
          }
        }

        if (!isDivine) return null;

        // æ£€æµ‹ç¥æ ¼ç­‰çº§
        let divineRank = 'demigod';
        if (/åŠç¥/.test(background)) divineRank = 'demigod';
        else if (/å¼±ç­‰ç¥|æ¬¡çº§ç¥/.test(background)) divineRank = 'lesser';
        else if (/ä¸­ç­‰ç¥/.test(background)) divineRank = 'intermediate';
        else if (/é«˜ç­‰ç¥|å¼ºå¤§ç¥/.test(background)) divineRank = 'greater';

        // æå–ç¥èŒ
        const portfolios = [];

        // æ–¹å¼1: ä»ã€ç¥èŒï¼šxxxã€‘æå–
        const bracketPattern = /ã€ç¥èŒ[ï¼š:]\s*([^ã€‘]+)ã€‘/g;
        let match;
        while ((match = bracketPattern.exec(background)) !== null) {
          const domains = match[1].trim().split(/[ã€ï¼Œ,]/);
          portfolios.push(...domains.map(d => d.trim()).filter(d => d));
        }

        // æ–¹å¼2: ä»"ç¥èŒï¼š"æå–
        if (portfolios.length === 0) {
          const portfolioPattern = /ç¥èŒ[ï¼š:]\s*([^ã€‚ï¼ï¼Ÿ\nã€ã€‘]+)/g;
          while ((match = portfolioPattern.exec(background)) !== null) {
            const domains = match[1].trim().split(/[ã€ï¼Œ,]/);
            portfolios.push(...domains.map(d => d.trim()).filter(d => d));
          }
        }

        console.log('è§£æç»“æœ:', { divineRank, portfolios });

        return {
          type: 'update_deity',
          data: {
            divineRank,
            portfolios,
          },
        };
      }

      function addResult(title, content, type = 'info') {
        const resultsDiv = document.getElementById('results');
        const section = document.createElement('div');
        section.className = 'section';
        section.innerHTML = `<h2>${title}</h2><pre>${content}</pre>`;
        resultsDiv.appendChild(section);
      }

      function checkGameState() {
        document.getElementById('results').innerHTML = '';

        try {
          // å°è¯•ä»è§’è‰²å¡å˜é‡ä¸­è·å–æ¸¸æˆçŠ¶æ€
          if (typeof getVariables === 'undefined') {
            addResult('âŒ é”™è¯¯', 'å½“å‰ä¸åœ¨é…’é¦†ç¯å¢ƒä¸­ï¼Œæ— æ³•è®¿é—® getVariables å‡½æ•°', 'error');
            return;
          }

          const charVars = getVariables({ type: 'character' });
          const gameState = charVars?.adnd2e?.gameState;

          if (!gameState) {
            addResult('âš ï¸ è­¦å‘Š', 'æœªæ‰¾åˆ°æ¸¸æˆçŠ¶æ€æ•°æ®', 'warning');
            addResult('è§’è‰²å¡å˜é‡å®Œæ•´å†…å®¹', JSON.stringify(charVars, null, 2));
            return;
          }

          const deity = gameState.character?.deity;

          if (deity) {
            addResult('âœ… ç¥ç¥‡æ•°æ®å­˜åœ¨', JSON.stringify(deity, null, 2), 'success');
          } else {
            addResult(
              'âš ï¸ ç¥ç¥‡æ•°æ®ä¸å­˜åœ¨',
              'æ¸¸æˆçŠ¶æ€ä¸­æ²¡æœ‰ç¥ç¥‡æ•°æ®\n\nå®Œæ•´æ¸¸æˆçŠ¶æ€ï¼š\n' + JSON.stringify(gameState, null, 2),
              'warning',
            );
          }
        } catch (error) {
          addResult('âŒ é”™è¯¯', error.toString(), 'error');
        }
      }

      function checkCharacterData() {
        document.getElementById('results').innerHTML = '';

        try {
          if (typeof getVariables === 'undefined') {
            addResult('âŒ é”™è¯¯', 'å½“å‰ä¸åœ¨é…’é¦†ç¯å¢ƒä¸­', 'error');
            return;
          }

          const charVars = getVariables({ type: 'character' });
          const character = charVars?.adnd2e?.character;

          if (!character) {
            addResult('âŒ é”™è¯¯', 'æœªæ‰¾åˆ°è§’è‰²å¡æ•°æ®', 'error');
            return;
          }

          addResult(
            'è§’è‰²åŸºæœ¬ä¿¡æ¯',
            `
å§“å: ${character.characterName || 'æœªçŸ¥'}
ç§æ—: ${character.race || 'æœªçŸ¥'}
èŒä¸š: ${character.class || 'æœªçŸ¥'}
`,
            'info',
          );

          if (character.background) {
            addResult('è§’è‰²èƒŒæ™¯', character.background, 'info');

            // æµ‹è¯•è§£æ
            const deityCommand = parseDeityFromCharacterBackground(character.background);
            if (deityCommand) {
              addResult('âœ… èƒŒæ™¯ä¸­æ£€æµ‹åˆ°ç¥ç¥‡ä¿¡æ¯', JSON.stringify(deityCommand, null, 2), 'success');
            } else {
              addResult('âš ï¸ èƒŒæ™¯ä¸­æœªæ£€æµ‹åˆ°ç¥ç¥‡ä¿¡æ¯', 'è§£æå‡½æ•°æœªèƒ½è¯†åˆ«ç¥ç¥‡å…³é”®è¯', 'warning');
            }
          } else {
            addResult('âš ï¸ è­¦å‘Š', 'è§’è‰²å¡ä¸­æ²¡æœ‰èƒŒæ™¯æè¿°', 'warning');
          }

          if (character.deity) {
            addResult('âœ… è§’è‰²å¡ä¸­æœ‰ç¥ç¥‡æ•°æ®', JSON.stringify(character.deity, null, 2), 'success');
          } else {
            addResult('âš ï¸ è§’è‰²å¡ä¸­æ²¡æœ‰ç¥ç¥‡æ•°æ®', 'è§’è‰²å¡çš„ deity å­—æ®µä¸ºç©º', 'warning');
          }
        } catch (error) {
          addResult('âŒ é”™è¯¯', error.toString() + '\n\n' + error.stack, 'error');
        }
      }

      function testDeityParsing() {
        document.getElementById('results').innerHTML = '';

        const testCases = [
          'è¿‡å»æ˜¯åŒ—æ–¹ç»Ÿä¸€çš„ç‹¼è£”éƒ¨è½çš„å¼ºå¤§å±•ç¤ºï¼Œæœ€åå€ŸåŠ©é¦–é¢†å’ŒåŒæ—ä»¬çš„å¸®åŠ©æˆä¸ºç‹¼è£”çš„å®ˆæŠ¤ç¥ï¼Œå› ä¸ºæ˜¯åŠç¥ï¼Œæ‰€ä»¥å¯ä»¥å±…ä½åœ¨ç‰©è´¨ä½é¢ï¼Œä¸ä¼šè¢«è¿«å»å…¶ä»–ä½é¢ã€ç¥èŒï¼šç‹¼è£”ã€æ€§çˆ±ï¼ˆé›„æ€§é—´çš„åŒæ€§äº¤é…ï¼‰ã€å®¿å‘½è®ºã€‘',
          'ä»–æˆä¸ºäº†åŠç¥',
          'å‘¨é”¦è·å¾—äº†ç¥åŠ›',
          'æ™®é€šçš„èƒŒæ™¯æè¿°ï¼Œæ²¡æœ‰æåˆ°æˆç¥',
        ];

        testCases.forEach((testCase, index) => {
          const result = parseDeityFromCharacterBackground(testCase);
          if (result) {
            addResult(
              `âœ… æµ‹è¯• ${index + 1}`,
              `è¾“å…¥: ${testCase}\n\nè§£æç»“æœ:\n${JSON.stringify(result, null, 2)}`,
              'success',
            );
          } else {
            addResult(`âš ï¸ æµ‹è¯• ${index + 1}`, `è¾“å…¥: ${testCase}\n\næœªæ£€æµ‹åˆ°ç¥ç¥‡ä¿¡æ¯`, 'warning');
          }
        });
      }

      function manuallySetDeity() {
        if (typeof replaceVariables === 'undefined') {
          addResult('âŒ é”™è¯¯', 'å½“å‰ä¸åœ¨é…’é¦†ç¯å¢ƒä¸­', 'error');
          return;
        }

        try {
          const charVars = getVariables({ type: 'character' });

          if (!charVars?.adnd2e?.gameState) {
            addResult('âŒ é”™è¯¯', 'æœªæ‰¾åˆ°æ¸¸æˆçŠ¶æ€', 'error');
            return;
          }

          // æ‰‹åŠ¨è®¾ç½®ç¥ç¥‡æ•°æ®
          charVars.adnd2e.gameState.character.deity = {
            divineRank: 'demigod',
            portfolios: ['ç‹¼è£”', 'æ€§çˆ±ï¼ˆé›„æ€§é—´çš„åŒæ€§äº¤é…ï¼‰', 'å®¿å‘½è®º'],
            magicResistance: 70,
            divineAbilities: [],
            maxAvatars: 1,
            sensingRange: 1,
          };

          replaceVariables(charVars, { type: 'character' });

          addResult('âœ… æˆåŠŸ', 'å·²æ‰‹åŠ¨è®¾ç½®ç¥ç¥‡æ•°æ®ï¼Œè¯·åˆ·æ–°æ¸¸æˆç•Œé¢æŸ¥çœ‹æ•ˆæœ', 'success');

          // è§¦å‘è‡ªå®šä¹‰äº‹ä»¶é€šçŸ¥å‰ç«¯æ›´æ–°
          if (typeof eventEmit === 'function') {
            eventEmit('adnd2e_character_data_synced');
          }
        } catch (error) {
          addResult('âŒ é”™è¯¯', error.toString() + '\n\n' + error.stack, 'error');
        }
      }
    </script>
  </body>
</html>
